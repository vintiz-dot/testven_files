<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Galaxy: Do, Does, Did</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        display: ['Quicksand', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            purple: '#8B5CF6',
                            blue: '#3B82F6',
                            pink: '#EC4899',
                            teal: '#14B8A6',
                            yellow: '#F59E0B',
                            bg: '#F3F4F6',
                            dark: '#1e1b4b'
                        }
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F0F4F8;
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            background-size: cover;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .glass-dark {
            background: rgba(30, 27, 75, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-premium {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            transition: all 0.2s;
            box-shadow: 0 4px 14px 0 rgba(124, 58, 237, 0.39);
        }

        .btn-premium:active {
            transform: scale(0.96);
        }

        .btn-test {
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
            transition: all 0.2s;
            box-shadow: 0 4px 14px 0 rgba(234, 88, 12, 0.39);
        }

        .correct-anim {
            animation: correctPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes correctPop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
                background-color: #86efac;
            }

            100% {
                transform: scale(1);
            }
        }

        .character-float {
            animation: float 5s ease-in-out infinite;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.5);
        }
    </style>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
            (function () {
                // https://dashboard.emailjs.com/admin/account
                emailjs.init("GpWE40ze9vHUQ60Qk");
            })();
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function () {
            emailjs.init("GpWE40ze9vHUQ60Qk");
        })();
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function () {
            emailjs.init("GpWE40ze9vHUQ60Qk");
        })();
    </script>
</head>

<body class="text-slate-800 font-sans overflow-x-hidden selection:bg-brand-purple selection:text-white">

    <!-- App Container -->
    <div id="app" class="relative max-w-6xl mx-auto min-h-screen flex flex-col p-4 md:p-6 lg:p-8">

        <!-- Header -->
        <header class="flex justify-between items-center mb-8 z-10">
            <div class="flex items-center gap-3">
                <div
                    class="w-12 h-12 rounded-2xl bg-gradient-to-br from-brand-blue to-brand-purple flex items-center justify-center shadow-lg text-white">
                    <i data-lucide="rocket" class="w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="font-display font-bold text-2xl text-white tracking-tight">Grammar Galaxy</h1>
                    <p class="text-slate-300 text-xs font-medium">IB PYP Grade 2 ‚Ä¢ Inquiry Module</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div
                    class="hidden md:flex items-center gap-2 bg-white/10 backdrop-blur-md px-4 py-2 rounded-full border border-white/20">
                    <i data-lucide="trophy" class="w-5 h-5 text-yellow-400"></i>
                    <span id="score-display" class="font-bold text-white">0 XP</span>
                </div>
                <button onclick="toggleSound()"
                    class="w-10 h-10 rounded-full bg-white/10 backdrop-blur-md border border-white/20 flex items-center justify-center text-white hover:bg-white/20 transition">
                    <i data-lucide="volume-2" class="w-5 h-5" id="sound-icon"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 flex flex-col relative z-10">
            <!-- Dynamic Content Injected Here -->
        </main>

        <!-- Navigation Dots (Progress) -->
        <div
            class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-20 glass-panel px-6 py-3 rounded-full flex gap-3 shadow-2xl">
            <button onclick="navigateTo('home')"
                class="nav-dot w-3 h-3 rounded-full bg-brand-purple transition-all duration-300 hover:scale-125"></button>
            <button onclick="navigateTo('learn')"
                class="nav-dot w-3 h-3 rounded-full bg-slate-300 transition-all duration-300 hover:scale-125"></button>
            <button onclick="navigateTo('practice')"
                class="nav-dot w-3 h-3 rounded-full bg-slate-300 transition-all duration-300 hover:scale-125"></button>
            <button onclick="navigateTo('test')"
                class="nav-dot w-3 h-3 rounded-full bg-slate-300 transition-all duration-300 hover:scale-125"></button>
        </div>

    </div>

    <!-- Screen Templates (Hidden) -->
    <template id="screen-home">
        <div class="h-full flex flex-col md:flex-row items-center justify-center gap-12 mt-10">
            <div class="md:w-1/2 space-y-6 text-center md:text-left">
                <div
                    class="inline-block px-4 py-1.5 rounded-full bg-black/40 border border-brand-teal/50 text-brand-teal font-bold text-sm mb-2 backdrop-blur-sm shadow-sm">
                    ‚ú® Current Unit: How We Express Ourselves
                </div>

                <!-- Added High Contrast "Cockpit" Container -->
                <div
                    class="bg-slate-900/60 backdrop-blur-md p-8 rounded-3xl border border-white/20 shadow-2xl relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent pointer-events-none">
                    </div>
                    <h2
                        class="text-5xl md:text-6xl font-display font-extrabold text-white leading-tight mb-6 drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)]">
                        Master the <br>
                        <span
                            class="text-transparent bg-clip-text bg-gradient-to-r from-brand-pink to-yellow-300 filter drop-shadow-sm">Magic
                            Words</span>
                    </h2>

                    <p
                        class="text-white font-bold text-xl md:text-2xl leading-relaxed drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] tracking-wide">
                        Join Captain Cosmo on a journey through time! Learn when to use <span
                            class="text-yellow-300 underline decoration-2 underline-offset-4">Do</span>, <span
                            class="text-pink-300 underline decoration-2 underline-offset-4">Does</span>, and <span
                            class="text-purple-300 underline decoration-2 underline-offset-4">Did</span> to unlock the
                        secrets of the galaxy.
                    </p>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start pt-4">
                    <!-- High Contrast Action Button (Yellow/Black) -->
                    <button onclick="navigateTo('learn')"
                        class="bg-yellow-400 hover:bg-yellow-300 text-slate-900 px-8 py-4 rounded-2xl font-black text-xl flex items-center justify-center gap-2 shadow-[0_0_30px_rgba(250,204,21,0.6)] border-4 border-yellow-200 transform transition hover:scale-105 active:scale-95 uppercase tracking-wide">
                        <i data-lucide="play-circle" class="w-7 h-7"></i> Start Mission
                    </button>

                    <button onclick="navigateTo('practice')"
                        class="px-8 py-4 rounded-2xl bg-white/20 text-white font-bold text-lg hover:bg-white/30 backdrop-blur-md border-2 border-white/40 transition flex items-center justify-center gap-2 shadow-lg drop-shadow-md">
                        <i data-lucide="gamepad-2"></i> Practice
                    </button>
                    <button onclick="startTest()"
                        class="px-8 py-4 rounded-2xl bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold text-lg hover:scale-105 transition flex items-center justify-center gap-2 shadow-lg border-2 border-orange-400 drop-shadow-md">
                        <i data-lucide="clipboard-check"></i> Test
                    </button>
                </div>
            </div>
            <div class="md:w-1/2 flex justify-center">
                <div class="relative w-80 h-80 md:w-96 md:h-96">
                    <div class="absolute inset-0 bg-brand-purple/30 rounded-full blur-3xl animate-pulse-slow"></div>
                    <!-- Robot Avatar SVG -->
                    <svg class="character-float relative z-10 w-full h-full drop-shadow-2xl" viewBox="0 0 200 200"
                        fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="100" cy="100" r="80" fill="url(#grad1)" />
                        <rect x="60" y="70" width="80" height="60" rx="20" fill="white" />
                        <circle cx="85" cy="95" r="8" fill="#3B82F6" />
                        <circle cx="115" cy="95" r="8" fill="#3B82F6" />
                        <path d="M90 115 Q100 125 110 115" stroke="#3B82F6" stroke-width="4" stroke-linecap="round" />
                        <rect x="50" y="90" width="10" height="20" rx="5" fill="#A855F7" />
                        <rect x="140" y="90" width="10" height="20" rx="5" fill="#A855F7" />
                        <circle cx="100" cy="50" r="10" fill="#F59E0B" />
                        <rect x="98" y="60" width="4" height="10" fill="#64748B" />
                        <defs>
                            <linearGradient id="grad1" x1="0" y1="0" x2="200" y2="200" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#818CF8" />
                                <stop offset="1" stop-color="#C084FC" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>
    </template>

    <template id="screen-learn">
        <div class="w-full max-w-4xl mx-auto animate-fade-in-up">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-3xl font-display font-bold text-white">Mission Briefing</h2>
                <div class="flex gap-2">
                    <span class="px-3 py-1 rounded-lg bg-white/20 text-white text-sm font-bold backdrop-blur-md">UDL:
                        Visual</span>
                    <span class="px-3 py-1 rounded-lg bg-white/20 text-white text-sm font-bold backdrop-blur-md">UDL:
                        Auditory</span>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Present Tense Card -->
                <div class="glass-card p-6 rounded-3xl relative overflow-hidden group">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-brand-blue/20 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110">
                    </div>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-3 bg-blue-100 text-brand-blue rounded-xl">
                            <i data-lucide="sun" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800">Right Now (Present)</h3>
                    </div>

                    <div class="space-y-4">
                        <div onclick="speak('Does he play? Yes, he does.')"
                            class="bg-white p-4 rounded-2xl border-l-4 border-brand-pink shadow-sm cursor-pointer hover:bg-slate-50 transition">
                            <div class="flex justify-between items-start">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">One
                                    Person (He/She/It)</span>
                                <i data-lucide="volume-2" class="w-4 h-4 text-slate-400"></i>
                            </div>
                            <p class="text-lg font-bold text-slate-700">
                                <span class="text-brand-pink">Does</span> he play?
                            </p>
                            <p class="text-sm text-slate-500 mt-1">Yes, he <span
                                    class="text-brand-pink font-bold">does</span>. / No, he <span
                                    class="text-brand-pink font-bold">doesn't</span>.</p>
                        </div>

                        <div onclick="speak('Do they play? Yes, they do.')"
                            class="bg-white p-4 rounded-2xl border-l-4 border-brand-blue shadow-sm cursor-pointer hover:bg-slate-50 transition">
                            <div class="flex justify-between items-start">
                                <span
                                    class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Groups
                                    & You (I/You/We/They)</span>
                                <i data-lucide="volume-2" class="w-4 h-4 text-slate-400"></i>
                            </div>
                            <p class="text-lg font-bold text-slate-700">
                                <span class="text-brand-blue">Do</span> they play?
                            </p>
                            <p class="text-sm text-slate-500 mt-1">Yes, they <span
                                    class="text-brand-blue font-bold">do</span>. / No, they <span
                                    class="text-brand-blue font-bold">don't</span>.</p>
                        </div>
                    </div>
                </div>

                <!-- Past Tense Card -->
                <div class="glass-card p-6 rounded-3xl relative overflow-hidden group">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-brand-purple/20 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110">
                    </div>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-3 bg-purple-100 text-brand-purple rounded-xl">
                            <i data-lucide="history" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800">Yesterday (Past)</h3>
                    </div>

                    <div
                        class="bg-gradient-to-br from-brand-purple to-indigo-600 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden">
                        <i data-lucide="sparkles" class="absolute top-4 right-4 text-white/20 w-12 h-12"></i>
                        <p class="text-sm font-medium text-white/80 mb-2">The Magic Rule:</p>
                        <h4 class="text-2xl font-bold mb-4">Everyone uses DID!</h4>
                        <div onclick="speak('Did you go to the park?')"
                            class="bg-white/10 backdrop-blur-sm p-3 rounded-xl border border-white/20 cursor-pointer hover:bg-white/20 transition">
                            <p class="font-medium">Did he...? Did they...? Did I...?</p>
                            <p class="text-sm mt-1 text-white/70">It never changes!</p>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-yellow-50 rounded-2xl border border-yellow-100">
                        <div class="flex gap-2 items-center text-yellow-700 font-bold mb-1">
                            <i data-lucide="clock" class="w-4 h-4"></i> Time Words
                        </div>
                        <p class="text-sm text-yellow-800">Yesterday, Last week, Last night, 2 days ago.</p>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-center">
                <button onclick="navigateTo('practice')"
                    class="btn-premium px-10 py-4 rounded-full text-white font-bold text-xl shadow-xl hover:scale-105 transition flex items-center gap-2">
                    Let's Practice! <i data-lucide="arrow-right"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- Practice Screen (Guided) -->
    <template id="screen-practice">
        <div class="max-w-3xl mx-auto w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold text-xl"><i data-lucide="gamepad-2" class="inline w-6 h-6 mr-2"></i>
                    Practice Mode</h3>
                <span class="bg-white/20 text-white px-3 py-1 rounded-full text-sm">Infinite Questions</span>
            </div>

            <div class="w-full bg-slate-700/30 h-3 rounded-full mb-8 backdrop-blur-sm overflow-hidden">
                <div id="practice-progress"
                    class="h-full bg-gradient-to-r from-brand-teal to-brand-blue w-0 transition-all duration-500"></div>
            </div>

            <div
                class="glass-card p-8 md:p-12 rounded-[2rem] shadow-2xl relative min-h-[400px] flex flex-col items-center justify-center text-center">

                <div id="feedback-overlay"
                    class="absolute inset-0 z-20 hidden rounded-[2rem] flex items-center justify-center bg-white/90 backdrop-blur-md transition-all">
                    <div class="text-center">
                        <div id="feedback-icon"
                            class="w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center text-white text-4xl shadow-xl scale-0 transition-transform duration-300">
                        </div>
                        <h3 id="feedback-text" class="text-3xl font-display font-bold text-slate-800 mb-2"></h3>
                        <p id="feedback-sub" class="text-slate-500 mb-6"></p>
                        <button onclick="nextQuestion()"
                            class="btn-premium px-8 py-3 rounded-xl text-white font-bold shadow-lg">Next Star!</button>
                    </div>
                </div>

                <div class="w-full">
                    <div class="flex justify-center mb-6">
                        <span id="q-tag"
                            class="px-4 py-1.5 rounded-full bg-slate-100 text-slate-600 text-sm font-bold uppercase tracking-wider border border-slate-200"></span>
                    </div>

                    <div class="mb-8 relative inline-block">
                        <h3 class="text-3xl md:text-5xl font-display font-bold text-slate-800 leading-tight"
                            id="question-text"></h3>
                        <button onclick="speakCurrentQuestion()"
                            class="absolute -right-12 top-1/2 -translate-y-1/2 p-2 rounded-full text-brand-purple hover:bg-brand-purple/10 transition">
                            <i data-lucide="volume-2" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 w-full max-w-2xl mx-auto" id="options-container">
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Test Screen (Assessment) -->
    <template id="screen-test">
        <div class="max-w-3xl mx-auto w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold text-xl text-orange-200"><i data-lucide="clipboard-check"
                        class="inline w-6 h-6 mr-2"></i> Cosmic Test</h3>
                <span id="test-counter" class="bg-orange-500 text-white px-3 py-1 rounded-full text-sm font-bold">Q 1 /
                    10</span>
            </div>

            <div
                class="glass-dark p-8 md:p-12 rounded-[2rem] shadow-2xl relative min-h-[400px] flex flex-col items-center justify-center text-center border-orange-500/30">

                <div class="w-full">
                    <div class="mb-8 relative inline-block">
                        <h3 class="text-2xl md:text-4xl font-display font-bold text-white leading-tight"
                            id="test-question-text"></h3>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 w-full max-w-2xl mx-auto"
                        id="test-options-container">
                        <!-- Options injected by JS -->
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center">
                <p class="text-orange-200/60 text-sm">Choose carefully! No hints in the Test Zone.</p>
            </div>
        </div>
    </template>

    <!-- Result Screen -->
    <template id="screen-result">
        <div class="max-w-4xl mx-auto w-full text-center">
            <div class="glass-panel p-8 rounded-3xl mb-8">
                <h2 class="text-4xl font-display font-bold text-white mb-4" id="result-title">Challenge Complete!</h2>
                <p class="text-slate-200 text-xl mb-8" id="result-subtitle">You are a Grammar Master!</p>

                <div class="flex justify-center items-center gap-8 mb-8">
                    <div class="text-center">
                        <div
                            class="w-24 h-24 bg-white rounded-full flex items-center justify-center text-4xl mb-2 shadow-lg mx-auto">
                            ‚≠ê</div>
                        <p class="font-bold text-white">Final Score</p>
                        <p class="text-4xl text-yellow-300 font-bold" id="final-score">0</p>
                    </div>
                </div>

                <!-- Email Submission Form -->
                <div class="glass-dark p-6 rounded-2xl max-w-md mx-auto mb-8 border border-white/10">
                    <h3 class="text-xl font-bold text-white mb-4">Submit Your Results üìß</h3>
                    <div class="flex flex-col gap-3">
                        <input type="text" id="student-name" placeholder="Enter Your Name"
                            class="p-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:border-brand-purple transition">
                        <button onclick="submitResults()" id="btn-submit"
                            class="bg-brand-purple hover:bg-brand-purple/80 text-white font-bold py-3 rounded-xl transition flex justify-center items-center gap-2">
                            <span>Send to Teacher</span>
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                        <p id="email-status" class="text-sm font-bold min-h-[20px]"></p>
                    </div>
                </div>

                <div class="flex gap-4 justify-center">
                    <button onclick="navigateTo('home')"
                        class="bg-white/20 text-white px-8 py-4 rounded-2xl font-bold text-lg hover:bg-white/30 transition shadow-lg border border-white/20">
                        Main Menu
                    </button>
                    <button onclick="startTest()"
                        class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-2xl font-bold text-lg hover:scale-105 transition shadow-xl">
                        Retry Test
                    </button>
                </div>
            </div>
        </div>
    </template>

    <script>
        // --- Questions Database ---
        const QUESTION_BANK = [
            // Present - Do
            { text: "___ you play soccer every day?", options: ["Do", "Does", "Did"], correct: "Do", type: "present", hint: "Use 'Do' for You, We, They.", tag: "Habit" },
            { text: "___ we have school today?", options: ["Do", "Does", "Did"], correct: "Do", type: "present", hint: "Use 'Do' for 'We'.", tag: "Fact" },
            { text: "___ I need a pencil?", options: ["Do", "Does", "Did"], correct: "Do", type: "present", hint: "Use 'Do' for 'I'.", tag: "Question" },
            { text: "___ Tom and Jerry run fast?", options: ["Do", "Does", "Did"], correct: "Do", type: "present", hint: "Two people = They.", tag: "Plural Subject" },
            { text: "___ your friends play games?", options: ["Do", "Does", "Did"], correct: "Do", type: "present", hint: "Friends = They.", tag: "Plural Subject" },
            { text: "___ you like pizza?", options: ["Do", "Does", "Did"], correct: "Do", type: "present", hint: "Use 'Do' for 'You'.", tag: "Preference" },

            // Present - Does
            { text: "___ she like ice cream?", options: ["Do", "Does", "Did"], correct: "Does", type: "present", hint: "Use 'Does' for She.", tag: "General Fact" },
            { text: "___ it rain a lot here?", options: ["Do", "Does", "Did"], correct: "Does", type: "present", hint: "Use 'Does' for It.", tag: "Weather" },
            { text: "___ your mom cook dinner?", options: ["Do", "Does", "Did"], correct: "Does", type: "present", hint: "One person (She) = Does.", tag: "Third Person" },
            { text: "___ John watch TV daily?", options: ["Do", "Does", "Did"], correct: "Does", type: "present", hint: "John (He) = Does.", tag: "Habit" },
            { text: "___ the dog bark often?", options: ["Do", "Does", "Did"], correct: "Does", type: "present", hint: "The dog (It) = Does.", tag: "Habit" },
            { text: "Where ___ she live?", options: ["do", "does", "did"], correct: "does", type: "present", hint: "One person (She) = does.", tag: "Wh- Question" },

            // Past - Did (Time Markers)
            { text: "___ they go to the park yesterday?", options: ["Do", "Does", "Did"], correct: "Did", type: "past", hint: "'Yesterday' = Past.", tag: "Yesterday" },
            { text: "___ it rain last night?", options: ["Do", "Does", "Did"], correct: "Did", type: "past", hint: "'Last night' = Past.", tag: "Last Night" },
            { text: "What ___ you do last summer?", options: ["do", "does", "did"], correct: "did", type: "past", hint: "'Last summer' = Past.", tag: "Past Question" },
            { text: "___ he finish his homework last night?", options: ["Do", "Does", "Did"], correct: "Did", type: "past", hint: "Look at the time: Last night.", tag: "Past Action" },
            { text: "___ the bus arrive late yesterday?", options: ["Do", "Does", "Did"], correct: "Did", type: "past", hint: "'Yesterday' is finished.", tag: "Past Event" },
            { text: "Why ___ you cry last week?", options: ["do", "does", "did"], correct: "did", type: "past", hint: "'Last week' is past.", tag: "Wh- Question" },
            { text: "___ they visit grandma two days ago?", options: ["Do", "Does", "Did"], correct: "Did", type: "past", hint: "'Ago' means past.", tag: "Time Ago" },

            // Negatives & Context
            { text: "No, he ___ not eat the apple.", options: ["do", "does", "did"], correct: "did", type: "past", hint: "It happened in the story (past).", tag: "Story/Negative" },
            { text: "She ___ not like spiders.", options: ["do", "does", "did"], correct: "does", type: "present", hint: "A fact about her now.", tag: "Negative Present" },
            { text: "We ___ not go to school yesterday.", options: ["do", "does", "did"], correct: "did", type: "past", hint: "Yesterday = did.", tag: "Negative Past" }
        ];

        // --- State Management ---
        const state = {
            score: 0,
            practiceIndex: 0,
            soundEnabled: true,
            mode: 'practice', // 'practice' or 'test'
            testQuestions: [],
            testIndex: 0,
            testScore: 0,
            testScore: 0,
            testHistory: [],
            practiceQuestions: []
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            navigateTo('home');
            updateScoreUI();
        });

        // --- Navigation ---
        function navigateTo(screenId) {
            const main = document.getElementById('main-content');
            const template = document.getElementById(`screen-${screenId}`);

            main.style.opacity = '0';
            main.style.transform = 'translateY(10px)';
            main.style.transition = 'all 0.3s ease-out';

            setTimeout(() => {
                main.innerHTML = '';
                main.appendChild(template.content.cloneNode(true));
                lucide.createIcons();

                updateNavDots(screenId);

                if (screenId === 'practice') {
                    state.mode = 'practice';
                    // Randomize Practice Questions on fresh entry
                    state.practiceQuestions = [...QUESTION_BANK].sort(() => 0.5 - Math.random());
                    state.practiceIndex = 0;
                    loadPracticeQuestion();
                }

                // Note: 'test' logic is handled by startTest() usually, but if nav clicked:
                if (screenId === 'test') {
                    startTest();
                }

                main.style.opacity = '1';
                main.style.transform = 'translateY(0)';
            }, 300);
        }

        function updateNavDots(screenId) {
            document.querySelectorAll('.nav-dot').forEach(dot => {
                dot.classList.remove('bg-brand-purple', 'scale-125');
                dot.classList.add('bg-slate-300');
            });

            const map = { 'home': 0, 'learn': 1, 'practice': 2, 'test': 3, 'result': 3 };
            const dots = document.querySelectorAll('.nav-dot');
            if (dots[map[screenId]]) {
                dots[map[screenId]].classList.remove('bg-slate-300');
                dots[map[screenId]].classList.add('bg-brand-purple', 'scale-125');
            }
        }

        // --- Practice Logic ---
        function loadPracticeQuestion() {
            // Check for completion
            if (state.practiceIndex >= state.practiceQuestions.length) {
                showPracticeComplete();
                return;
            }

            const q = state.practiceQuestions[state.practiceIndex];

            document.getElementById('question-text').innerText = q.text;
            document.getElementById('q-tag').innerText = q.tag;

            // Color code tag
            const qTag = document.getElementById('q-tag');
            if (q.type === 'past') {
                qTag.className = "px-4 py-1.5 rounded-full bg-brand-purple/20 text-brand-purple text-sm font-bold uppercase tracking-wider border border-brand-purple/30";
            } else {
                qTag.className = "px-4 py-1.5 rounded-full bg-brand-blue/20 text-brand-blue text-sm font-bold uppercase tracking-wider border border-brand-blue/30";
            }

            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            // Reset content wrapper if it was hidden by completion screen
            document.querySelector('#screen-practice .glass-card').style.display = 'flex';
            // Note: The previous implementation didn't hide the card, but showPracticeComplete might replace content.
            // Let's ensure showPracticeComplete clears content or replaces it safely.

            // Actually, let's just clear options and text if we reuse the same container.
            // But wait, the container structure needs to be maintained.

            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "glass-card px-6 py-4 rounded-xl text-xl font-bold text-slate-700 hover:text-white hover:bg-brand-purple hover:border-transparent shadow-sm transition-all duration-200 transform hover:scale-105 active:scale-95";
                btn.innerText = opt;
                btn.onclick = () => checkPracticeAnswer(opt, q.correct, q.hint);
                optionsContainer.appendChild(btn);
            });

            document.getElementById('feedback-overlay').classList.add('hidden');

            // Update Practice Bar (Finite)
            const progress = document.getElementById('practice-progress');
            if (progress) {
                const pct = ((state.practiceIndex) / state.practiceQuestions.length) * 100;
                progress.style.width = `${pct}%`;
            }
        }

        function showPracticeComplete() {
            const container = document.getElementById('options-container');
            const qText = document.getElementById('question-text');
            const qTag = document.getElementById('q-tag');

            // Clear current question UI
            container.innerHTML = '';
            qTag.innerText = "Mission Complete";
            qTag.className = "px-4 py-1.5 rounded-full bg-green-100 text-green-700 text-sm font-bold uppercase tracking-wider border border-green-200";

            qText.innerText = "All Practice Questions Completed!";

            // Add Test Button
            const btn = document.createElement('button');
            btn.className = "mt-8 bg-gradient-to-r from-orange-500 to-red-600 text-white text-2xl font-bold px-10 py-5 rounded-2xl shadow-xl hover:scale-105 transition-transform animate-bounce";
            btn.innerHTML = 'Take the Test üöÄ';
            btn.onclick = () => startTest();

            const wrapper = document.createElement('div');
            wrapper.className = "col-span-1 sm:col-span-3 flex justify-center";
            wrapper.appendChild(btn);

            container.appendChild(wrapper);

            // Full Progress Bar
            document.getElementById('practice-progress').style.width = '100%';
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        function checkPracticeAnswer(selected, correct, hint) {
            const overlay = document.getElementById('feedback-overlay');
            const icon = document.getElementById('feedback-icon');
            const title = document.getElementById('feedback-text');
            const sub = document.getElementById('feedback-sub');

            overlay.classList.remove('hidden');
            void icon.offsetWidth;
            icon.style.transform = "scale(1)";

            if (selected.toLowerCase() === correct.toLowerCase()) {
                icon.className = "w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center text-white text-4xl shadow-xl bg-green-500 animate-bounce";
                icon.innerHTML = '<i data-lucide="check"></i>';
                title.innerText = "Awesome!";
                sub.innerText = "You got it right!";
                state.score += 50;
                playSound('correct');
                confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 } });
            } else {
                icon.className = "w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center text-white text-4xl shadow-xl bg-red-400";
                icon.innerHTML = '<i data-lucide="x"></i>';
                title.innerText = "Oops!";
                sub.innerText = hint;
                playSound('wrong');
            }
            updateScoreUI();
            lucide.createIcons();
        }

        function nextQuestion() {
            state.practiceIndex++;
            loadPracticeQuestion();
        }

        // --- Test Logic ---
        function startTest() {
            // 1. Reset Test State
            state.mode = 'test';
            state.testScore = 0;
            state.testIndex = 0;
            state.testHistory = [];
            // 2. Randomly select 10 questions
            state.testQuestions = [...QUESTION_BANK].sort(() => 0.5 - Math.random()).slice(0, 10);

            // 3. Navigate
            const main = document.getElementById('main-content');
            const template = document.getElementById('screen-test');
            main.innerHTML = '';
            main.appendChild(template.content.cloneNode(true));
            lucide.createIcons();
            updateNavDots('test');

            loadTestQuestion();
        }

        function loadTestQuestion() {
            if (state.testIndex >= state.testQuestions.length) {
                showTestResults();
                return;
            }

            const q = state.testQuestions[state.testIndex];
            document.getElementById('test-question-text').innerText = q.text;
            document.getElementById('test-counter').innerText = `Question ${state.testIndex + 1} / 10`;

            const optionsContainer = document.getElementById('test-options-container');
            optionsContainer.innerHTML = '';

            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "bg-white/10 text-white border border-white/20 px-6 py-4 rounded-xl text-xl font-bold hover:bg-orange-500 hover:border-transparent hover:scale-105 transition-all duration-200 active:scale-95";
                btn.innerText = opt;
                btn.onclick = () => submitTestAnswer(opt, q.correct);
                optionsContainer.appendChild(btn);
            });
        }

        function submitTestAnswer(selected, correct) {
            // Track History
            const q = state.testQuestions[state.testIndex];
            const isCorrect = selected.toLowerCase() === correct.toLowerCase();
            state.testHistory.push({
                q: q.text,
                a: selected,
                c: correct,
                isCorrect: isCorrect
            });

            if (isCorrect) {
                state.testScore += 1;
                state.score += 100; // XP for correct test answers
            }
            state.testIndex++;
            loadTestQuestion();
        }

        function showTestResults() {
            navigateTo('result');
            setTimeout(() => {
                const percentage = (state.testScore / 10) * 100;
                document.getElementById('final-score').innerText = `${percentage}%`;

                const title = document.getElementById('result-title');
                const sub = document.getElementById('result-subtitle');

                if (percentage >= 80) {
                    title.innerText = "Galaxy Master! üèÜ";
                    sub.innerText = "You are a true Time Traveler!";
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                } else if (percentage >= 50) {
                    title.innerText = "Good Job! üöÄ";
                    sub.innerText = "Keep practicing to become a master.";
                } else {
                    title.innerText = "Mission Failed ‚ö†Ô∏è";
                    sub.innerText = "Let's review the rules in the Learn section.";
                }
                updateScoreUI();
            }, 100);
        }

        async function submitResults() {
            const name = document.getElementById('student-name').value.trim();
            const status = document.getElementById('email-status');
            const btn = document.getElementById('btn-submit');

            if (!name) { alert("Please enter your name!"); return; }

            status.innerText = "Sending...";
            status.className = "text-yellow-300 text-sm font-bold min-h-[20px]";
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            let msg = `Test Results for ${name}\n`;
            msg += `Score: ${state.testScore} / 10\n\n`;
            state.testHistory.forEach((h, i) => {
                msg += `${i + 1}. ${h.q}\n   Your Answer: ${h.a} (${h.isCorrect ? 'Correct ‚úÖ' : 'Wrong ‚ùå'})\n`;
                if (!h.isCorrect) msg += `   Correct Answer: ${h.c}\n`;
                msg += "\n";
            });

            const params = {
                name: name,
                time: new Date().toLocaleString(),
                message: msg
            };

            try {
                // service_m0h97uh
                await emailjs.send('service_m0h97uh', 'template_rzjx94s', params);
                status.innerText = "Results Sent Successfully! üöÄ";
                status.className = "text-green-400 text-sm font-bold min-h-[20px]";
                confetti({ particleCount: 50, spread: 60 });
            } catch (e) {
                console.error(e);
                status.innerText = "Failed to send. Try again.";
                status.className = "text-red-400 text-sm font-bold min-h-[20px]";
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- Shared Helpers ---
        function updateScoreUI() {
            const display = document.getElementById('score-display');
            if (display) display.innerText = `${state.score} XP`;
        }

        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            const icon = document.getElementById('sound-icon');
            if (state.soundEnabled) {
                icon.setAttribute('data-lucide', 'volume-2');
            } else {
                icon.setAttribute('data-lucide', 'volume-x');
            }
            lucide.createIcons();
        }

        function speak(text) {
            if (!state.soundEnabled) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            utterance.lang = 'en-US';
            window.speechSynthesis.speak(utterance);
        }

        function speakCurrentQuestion() {
            // Only for practice mode currently
            if (state.mode === 'practice') {
                const q = QUESTION_BANK[state.practiceIndex % QUESTION_BANK.length];
                const toRead = q.text.replace('___', 'Blank');
                speak(toRead);
            }
        }

        function playSound(type) {
            if (!state.soundEnabled) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;

            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            osc.connect(gain);
            gain.connect(ctx.destination);

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(300, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(200, ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            }
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        }
    </script>
</body>

</html>